<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PBO Item Finder</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#666769;
      --card:#02491D;
      --text:#ffffff;
      --accent:#eef3fb;
      --radius:10px;
    }

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    header{
      display:flex;
      justify-content:flex-end;
      padding:12px;
    }

    button{
      padding:10px 18px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      background:var(--accent);
      color:#000;
    }

    button.secondary{
      background:var(--accent);
      color:#000;
    }

    main{
      max-width:1000px;
      margin:0 auto;
      padding:12px;
    }

    .loading{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }

    select,input{
      padding:8px;
      border-radius:8px;
      border:none;
      min-width:220px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
    }

    th,td{
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,0.15);
      text-align:left;
    }

    .muted{opacity:0.8;margin-top:12px}
    .hidden{display:none}

    .dark-mode{
      --bg:#1A252C;
      --card:#023804;
    }
  </style>
</head>
<body>

<header id="mainHeader" class="hidden">
  <button id="darkToggle" class="secondary">ðŸŒ™ Dark Mode</button>
</header>

<main>

  <div id="loading" class="loading">
    <div>
      <img src="https://i.imgur.com/XZcfQzw.png" style="max-width:200px;margin-bottom:12px">
      <div class="muted">Loading...</div>
    </div>
  </div>

  <div id="app" class="hidden">

    <section class="card">
      <h2>Item Finder</h2>

      <!-- Fuzzy Search -->
      <div class="row">
        <input id="manualInput" type="text"
          placeholder="Search item (e.g. TM070, Trick Room)" />
      </div>

      <div class="row">
        <button id="manualBtn">Search</button>
        <button id="manualReset" class="secondary">Reset</button>
      </div>

      <div id="manualOut"></div>

      <hr style="margin:18px 0;opacity:0.2">

      <!-- Filtered Search -->
      <div class="row">
        <select id="categorySelect">
          <option value="">Select Category</option>
        </select>
      </div>

      <div class="row">
        <button id="filterBtn">Search</button>
        <button id="filterReset" class="secondary">Reset</button>
      </div>

      <div id="filterOut"></div>

    </section>
  </div>
</main>

<script>
const $ = id => document.getElementById(id);
const normalize = s => (s||'').toString().trim().toLowerCase();
const escapeHtml = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

const ITEM_CSV =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7A6OIMzNiZSJJxLyi3ybt1LKsuwLq02IJSHdzt5eRHG8FEr0PJu6e8dlTK-XeeRAZZYL13JRv0Gk0/pub?output=csv';

let rows = [];
let fields = [];

function loadData(){
  Papa.parse(ITEM_CSV,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      rows = res.data.filter(r => Object.values(r).some(v => v && String(v).trim() !== ''));
      fields = res.meta.fields;
      initUI();
      $('loading').style.display='none';
      $('app').classList.remove('hidden');
      $('mainHeader').classList.remove('hidden');
    }
  });
}

function initUI(){
  const itemKey     = fields[0]; // A Item
  const howKey      = fields[1]; // B How
  const whereKey    = fields[2]; // C Where
  const categoryKey = fields[3]; // D Category

  /* ===== Category Filter Init ===== */
  const categories = [...new Set(rows.map(r => r[categoryKey]).filter(Boolean))];
  categories.forEach(c => $('categorySelect').add(new Option(c,c)));

  /* ===== Fuzzy Search ===== */
  $('manualBtn').onclick = ()=>{
    const q = normalize($('manualInput').value);
    const out = $('manualOut');
    if(!q){
      out.innerHTML='<p class="muted">Enter search term.</p>';
      return;
    }

    const hits = rows.filter(r => normalize(r[itemKey]).includes(q));
    out.innerHTML = hits.length
      ? renderTable(hits,[itemKey,howKey,whereKey])
      : '<p class="muted">No results.</p>';
  };

  $('manualReset').onclick = ()=>{
    $('manualInput').value='';
    $('manualOut').innerHTML='';
  };

  /* ===== Filtered Search ===== */
  $('filterBtn').onclick = ()=>{
    const c = $('categorySelect').value;
    const out = $('filterOut');

    if(!c){
      out.innerHTML = '<p class="muted">Select category.</p>';
      return;
    }

    const hits = rows.filter(r => r[categoryKey] === c);
    out.innerHTML = hits.length
      ? renderTable(hits,[itemKey,howKey,whereKey])
      : '<p class="muted">No results.</p>';
  };

  $('filterReset').onclick = ()=>{
    $('categorySelect').selectedIndex = 0;
    $('filterOut').innerHTML='';
  };
}

function renderTable(data, cols){
  let html = '<table><thead><tr>';
  cols.forEach(c => html+=`<th>${escapeHtml(c)}</th>`);
  html += '</tr></thead><tbody>';

  data.forEach(r=>{
    html+='<tr>';
    cols.forEach(c => html+=`<td>${escapeHtml(String(r[c]||''))}</td>`);
    html+='</tr>';
  });

  html+='</tbody></table>';
  return html;
}

$('darkToggle').addEventListener('click',()=>{
  document.body.classList.toggle('dark-mode');
  $('darkToggle').textContent =
    document.body.classList.contains('dark-mode')
      ? 'â˜€ï¸ Light Mode'
      : 'ðŸŒ™ Dark Mode';
});

$('manualInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    e.preventDefault();
    $('manualBtn').click();
  }
});

loadData();
</script>

</body>
</html>
