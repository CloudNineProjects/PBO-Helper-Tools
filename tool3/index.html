<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBO FAQ</title>

<!-- PapaParse (robustes CSV parsing) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg-light: #666769;
    --bg-dark:  #1A252C;
    --card-light: #026503;
    --card-dark:  #023804;
    --title-color: #ffffff;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif}
  body { background: var(--bg-light); color: #fff; }

  body.dark { background: var(--bg-dark); color: #fff; }

  /* mode toggle (top-right, visible on loading and app) */
  .mode-toggle {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 1200;
    background: rgba(255,255,255,0.9);
    color: #111;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    user-select: none;
    font-size: 16px;
  }
  body.dark .mode-toggle { background: rgba(0,0,0,0.7); color: #fff; }

  /* Loading screen */
  .loader {
    min-height: 100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:14px;
    text-align:center;
  }
  .loader img.logo { width: 220px; height: 220px; object-fit:cover; border-radius:50%; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
  .load-btn {
    padding:10px 18px;
    border-radius:8px;
    border:none;
    background:#0b74de;
    color:white;
    cursor:pointer;
    font-size:16px;
  }
  .loading-text { color: rgba(255,255,255,0.85); margin-top:6px; font-size:0.95rem; }

  /* App wrapper */
  .wrap { max-width:760px; margin:28px auto; padding:18px; }
  .card {
    border-radius:12px;
    padding:18px;
    background: var(--card-light);
    color: #fff;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  }
  body.dark .card { background: var(--card-dark); }

  h1 { margin:0 0 12px 0; color:var(--title-color); font-size:20px; }

  label { display:block; font-size:0.95rem; margin-top:10px; margin-bottom:6px; color:#fff; }
  select, button, input[type="text"]{
    width:100%;
    box-sizing:border-box;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.1);
    font-size:15px;
    margin-bottom:10px;
  }

  /* Inputs styling light/dark */
  select { background: #fff; color: #000; }
  body.dark select { background: #000; color: #fff; border:1px solid rgba(255,255,255,0.06); }

  .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .controls button { width:auto; padding:10px 14px; border-radius:8px; }

  .results {
    margin-top:12px;
    background: rgba(255,255,255,0.06);
    padding:12px;
    border-radius:8px;
    color: inherit;
  }
  /* ensure explanation preserves formatting */
  pre.expl { white-space: pre-wrap; margin:0; font-family:inherit; }

  table{width:100%; border-collapse:collapse; margin-top:8px;}
  th, td { text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.06); vertical-align:top; }
  th { background: rgba(0,0,0,0.06); }

  /* small screens */
  @media (max-width:560px){
    .wrap{ padding:12px; margin:12px; }
    .loader img.logo { width: 180px; height:180px; }
  }
</style>
</head>
<body>
  <!-- Mode toggle (visible immediately) -->
  <div id="modeToggle" class="mode-toggle" title="Toggle dark/light">ðŸŒ™</div>

  <!-- Loading screen -->
  <div id="loading" class="loader" aria-live="polite">
    <img class="logo" src="https://i.imgur.com/XZcfQzw.png" alt="CloudNine logo">
    <button id="loadBtn" class="load-btn">Load Data</button>
    <div id="loadingText" class="loading-text" style="display:none">Loading...</div>
  </div>

  <!-- App -->
  <div id="app" class="wrap" style="display:none">
    <div class="card">
      <h1>PBO FAQ</h1>

      <label for="typeSelect">Type</label>
      <select id="typeSelect"><option value="">-- choose type --</option></select>

      <label for="subtypeSelect">Subtype</label>
      <select id="subtypeSelect" disabled><option value="">-- choose subtype --</option></select>

      <div class="controls" style="margin-top:8px">
        <button id="showBtn" style="background:#0b74de;color:#fff">Show</button>
        <button id="resetBtn" class="secondary" style="background:#eef3fb;color:#111">Reset</button>
      </div>

      <div id="out" class="results" style="display:none"></div>
    </div>
  </div>

<script>
/* Utility */
const $ = id => document.getElementById(id);
const escapeHtml = s => s==null ? '' : String(s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

const CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSfISqMJoPKSFFO4tRUY1V_L7J5C02XG7xbs_T0y7dcWdPjvAKX4064cVGHGgYJ7PFkiOHoy74j7KyU/pub?output=csv';

let rows = [], fields = [];
let keyType = null, keySubtype = null, keyExpl = null;

/* find header key */
function findKey(candidates){
  if(!fields || !fields.length) return null;
  for(const c of candidates){
    const found = fields.find(f => f && f.trim().toLowerCase() === c.toLowerCase());
    if(found) return found;
  }
  // includes fallback
  for(const c of candidates){
    const found = fields.find(f => f && f.trim().toLowerCase().includes(c.toLowerCase()));
    if(found) return found;
  }
  return fields[0];
}

/* load via PapaParse */
function loadData(){
  $('loadBtn').disabled = true;
  $('loadingText').style.display = 'block';
  $('loadingText').textContent = 'Loading...';
  Papa.parse(CSV, {
    download: true,
    header: true,
    skipEmptyLines: true,
    transformHeader: h => h ? h.trim() : h,
    complete: (res) => {
      rows = (res.data || []).filter(r => Object.values(r).some(v => v !== null && v !== undefined && String(v).trim() !== ''));
      fields = res.meta && res.meta.fields ? res.meta.fields.map(f => f.trim()) : Object.keys(rows[0] || {});
      // detect keys
      keyType = findKey(['type','category','a']);
      keySubtype = findKey(['subtype','sub-type','b']);
      keyExpl = findKey(['explanation','explain','content','c','explanation (c)']);
      // populate UI
      populateType();
      // show app
      $('loading').style.display = 'none';
      $('app').style.display = 'block';
    },
    error: (err) => {
      console.error('CSV load error', err);
      $('loadingText').textContent = 'Error loading data';
      $('loadBtn').disabled = false;
    }
  });
}

/* populate Type select: only unique Type values (deduplicated) */
function populateType(){
  const sel = $('typeSelect');
  sel.innerHTML = '<option value="">-- choose type --</option>';
  if(!keyType) return;
  const types = rows.map(r => (r[keyType]||'').toString().trim()).filter(Boolean);
  // unique preserving order
  const seen = new Set();
  const uniq = [];
  for(const t of types){
    if(!seen.has(t)){ uniq.push(t); seen.add(t); }
  }
  uniq.forEach(t => sel.appendChild(new Option(t,t)));
}

/* when type chosen, populate Subtype with ALL column-B values for that type (no de-dup) */
function populateSubtypeFor(typeVal){
  const sel = $('subtypeSelect');
  sel.innerHTML = '<option value="">-- choose subtype --</option>';
  sel.disabled = true;
  if(!typeVal) return;
  // pick rows that match Type exactly
  const matched = rows.filter(r => ((r[keyType]||'').toString().trim() === typeVal));
  if(!matched.length) return;
  // add every subtype value as option (including duplicates)
  matched.forEach(r => {
    const val = (r[keySubtype]||'').toString().trim();
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    sel.appendChild(opt);
  });
  sel.disabled = false;
}

/* render results table: headers Type|Subtype|Explanation; Explanation uses pre to show formatting */
function renderResults(matchingRows){
  if(!matchingRows || !matchingRows.length) return '<p>No results.</p>';
  const headers = [keyType, keySubtype, keyExpl].map(h=>h||'');
  let html = '<table><thead><tr>';
  headers.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
  html += '</tr></thead><tbody>';
  for(const r of matchingRows){
    html += '<tr>';
    html += `<td>${escapeHtml(r[keyType]||'')}</td>`;
    html += `<td>${escapeHtml(r[keySubtype]||'')}</td>`;
    // explanation: preserve whole content and line breaks using <pre>
    const expl = r[keyExpl] == null ? '' : String(r[keyExpl]);
    html += `<td><pre class="expl">${escapeHtml(expl)}</pre></td>`;
    html += '</tr>';
  }
  html += '</tbody></table>';
  return html;
}

/* events */
$('typeSelect').addEventListener('change', e => {
  const val = e.target.value;
  populateSubtypeFor(val);
  $('out').style.display = 'none';
});

$('showBtn').addEventListener('click', () => {
  const t = $('typeSelect').value;
  const s = $('subtypeSelect').value;
  if(!t || !s){ alert('Please select Type and Subtype'); return; }
  // find all rows matching both fields (exact)
  const matched = rows.filter(r => ( (r[keyType]||'').toString().trim() === t ) && ( (r[keySubtype]||'').toString().trim() === s ));
  $('out').innerHTML = renderResults(matched);
  $('out').style.display = 'block';
});

$('resetBtn').addEventListener('click', () => {
  $('typeSelect').selectedIndex = 0;
  $('subtypeSelect').innerHTML = '<option value="">-- choose subtype --</option>';
  $('subtypeSelect').disabled = true;
  $('out').innerHTML = '';
  $('out').style.display = 'none';
});

/* mode toggle */
const modeToggle = $('modeToggle');
function updateToggleIcon(){
  modeToggle.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
}
modeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  updateToggleIcon();
});
updateToggleIcon();

/* load button */
$('loadBtn').addEventListener('click', () => {
  // show small loading text
  $('loadingText').style.display = 'block';
  $('loadingText').textContent = 'Loading...';
  loadData();
});

</script>
</body>
</html>
