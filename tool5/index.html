<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PBO Route Planner</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg-light:#666769;
  --bg-dark:#1A252C;
  --card-light:#02491D;
  --card-dark:#023804;
  --accent:#F0F0F0;
  --text-light:#F0F0F0;
  --muted:rgba(255,255,255,0.85);
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif}
body{background:var(--bg-light);color:var(--text-light)}
body.dark{background:var(--bg-dark)}

.mode-toggle{
  position:fixed;top:12px;right:12px;z-index:2000;
  background:rgba(255,255,255,0.9);color:#111;
  padding:6px 10px;border-radius:8px;cursor:pointer
}
body.dark .mode-toggle{background:rgba(0,0,0,0.6);color:#F0F0F0}

.loader{
  min-height:100vh;display:flex;align-items:center;
  justify-content:center;flex-direction:column;gap:14px
}
.loader img.logo{
  width:200px;height:200px;border-radius:50%;object-fit:cover
}
.loading-text{opacity:.85}

.wrap{max-width:940px;margin:26px auto;padding:16px}
.card{
  border-radius:12px;padding:18px;
  background:var(--card-light);
  box-shadow:0 10px 30px rgba(0,0,0,0.08)
}
body.dark .card{background:var(--card-dark)}

label{display:block;margin-top:10px;margin-bottom:6px}
select,button{
  padding:10px 12px;border-radius:8px;font-size:15px;
  width:100%;box-sizing:border-box;margin-bottom:10px
}
select{background:#F0F0F0;color:#000}
.controls{display:flex;gap:10px}
.controls button{width:auto}

.results{margin-top:14px;background:rgba(255,255,255,0.04);padding:12px;border-radius:8px}
table{width:100%;border-collapse:collapse}
th,td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  text-align:center;
  vertical-align:middle;
}

.preview img{
  max-width:360px;border-radius:8px;
  cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.25)
}

.modal{
  position:fixed;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,0.75);z-index:3000
}
.modal img{max-width:95%;max-height:95%}
</style>
</head>

<body>

<!-- Dark Mode Toggle (nur im Haupt-Tool sichtbar) -->
<div id="modeToggle" class="mode-toggle" style="display:none">ðŸŒ™ Dark Mode</div>

<!-- ========= LOADING ========= -->
<div id="loading" class="loader">
  <img class="logo" src="https://i.imgur.com/XZcfQzw.png">
  <div class="loading-text">Loadingâ€¦</div>
</div>

<!-- ========= APP ========= -->
<div id="app" class="wrap" style="display:none">

<div class="card">
  <label>Region</label>
  <select id="regionSelect"></select>

  <label>Location</label>
  <select id="locationSelect" disabled></select>

  <div class="controls">
    <button id="showBtn">Show</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div id="out" class="results" style="display:none"></div>
  <div id="imagePreview" class="preview" style="display:none"></div>
</div>

<div class="card" style="margin-top:16px">
  <h3>EV Spot Finder</h3>

  <label>Region</label>
  <select id="evRegion"></select>

  <label>EV</label>
  <select id="evSelect" disabled></select>

  <div class="controls">
    <button id="evShow">Show</button>
    <button id="evReset">Reset</button>
  </div>

  <div id="evOutput" class="results" style="display:none"></div>
</div>
</div>

<div id="modal" class="modal"><img id="modalImg"></div>

<script>
const ROUTE_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vR1exPBTlYsrTJ0U4eLuFycLc6Vwwj3jtKgc6s4jZZa7UbSJLB_LJkcnIigkaJIYtBNHsicju6cv3FJ/pub?output=csv";
const EV_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3s-al3s9rwdhK0FHls7J368zMl0Hdryc_y6MVwwXaiWLpgzImXs_9YsC5lXkwRdi_aPMi_gRHfsei/pub?output=csv";

let rows=[],fields=[],keyRegion,keyLocation,keyTeleport,keyDirection,keyMap;
let evRows=[],evFields=[];

function findKey(c){return fields.find(f=>f.toLowerCase().includes(c))}

/* ---------- LOAD ROUTES ---------- */
function loadRoute(){
return new Promise(res=>{
Papa.parse(ROUTE_CSV,{
download:true,header:true,
complete:r=>{
rows=r.data;fields=r.meta.fields;
keyRegion=findKey("region");
keyLocation=findKey("location");
keyTeleport=findKey("teleport");
keyDirection=findKey("direction");
keyMap=findKey("map");
populateRegions();
res();
}});});
}

function populateRegions(){
regionSelect.innerHTML='<option value="">-- choose region --</option>';
[...new Set(rows.map(r=>r[keyRegion]).filter(Boolean))]
.forEach(v=>regionSelect.add(new Option(v,v)));
}

regionSelect.onchange=()=>{
locationSelect.innerHTML='<option value="">-- choose location --</option>';
locationSelect.disabled=true;
rows.filter(r=>r[keyRegion]===regionSelect.value)
.forEach(r=>locationSelect.add(new Option(r[keyLocation],r[keyLocation])));
locationSelect.disabled=false;
};

showBtn.onclick=()=>{
const matched=rows.filter(r=>r[keyRegion]===regionSelect.value&&r[keyLocation]===locationSelect.value);
out.innerHTML=renderTable(matched);
out.style.display="block";
imagePreview.innerHTML="";
matched.forEach(r=>{
if(r[keyMap]){
const img=document.createElement("img");
img.src=r[keyMap];
img.onclick=()=>openModal(r[keyMap]);
imagePreview.appendChild(img);
}});
imagePreview.style.display="flex";
};

resetBtn.onclick = () => {
  // Selects zurÃ¼cksetzen
  regionSelect.selectedIndex = 0;
  locationSelect.innerHTML = '<option value="">-- choose location --</option>';
  locationSelect.disabled = true;

  // Ausgabe & Bilder ausblenden
  out.style.display = "none";
  out.innerHTML = "";
  imagePreview.style.display = "none";
  imagePreview.innerHTML = "";
};

function renderTable(rs){
if(!rs.length)return"<p>No results.</p>";
let h="<table><thead><tr>";
[keyRegion,keyLocation,keyTeleport,keyDirection].forEach(k=>h+=`<th>${k}</th>`);
h+="</tr></thead><tbody>";
rs.forEach(r=>{
h+="<tr>";
[keyRegion,keyLocation,keyTeleport,keyDirection].forEach(k=>h+=`<td>${r[k]||""}</td>`);
h+="</tr>";
});
return h+"</tbody></table>";
}

/* ---------- EV ---------- */
function loadEv(){
return new Promise(res=>{
Papa.parse(EV_CSV,{
download:true,header:true,
complete:r=>{
evRows=r.data;evFields=r.meta.fields;
populateEvRegions();
res();
}});});
}

function populateEvRegions(){
evRegion.innerHTML='<option value="">-- choose region --</option>';
[...new Set(evRows.map(r=>r[evFields[0]]).filter(Boolean))]
.forEach(v=>evRegion.add(new Option(v,v)));
}

evRegion.onchange=()=>{
evSelect.innerHTML='<option value="">-- choose EV --</option>';
evSelect.disabled=true;
const evKey=evFields[2];
[...new Set(evRows
.filter(r=>r[evFields[0]]===evRegion.value)
.map(r=>r[evKey]).filter(Boolean))]
.forEach(v=>evSelect.add(new Option(v,v)));
evSelect.disabled=false;
};

evShow.onclick=()=>{
const rows=evRows.filter(r=>r[evFields[0]]===evRegion.value&&r[evFields[2]]===evSelect.value);
evOutput.innerHTML=renderEv(rows);
evOutput.style.display="block";
};

evReset.onclick = () => {
  evRegion.selectedIndex = 0;
  evSelect.innerHTML = '<option value="">-- choose EV --</option>';
  evSelect.disabled = true;
  evOutput.style.display = "none";
  evOutput.innerHTML = "";
};

function renderEv(rs){
if(!rs.length)return"<p>No results.</p>";
let h="<table><thead><tr>";
evFields.slice(0,5).forEach(f=>h+=`<th>${f}</th>`);
h+="</tr></thead><tbody>";
rs.forEach(r=>{
h+="<tr>";
evFields.slice(0,5).forEach(f=>h+=`<td>${r[f]||""}</td>`);
h+="</tr>";
});
return h+"</tbody></table>";
}

/* ---------- SHARED ---------- */
function openModal(src){modal.style.display="flex";modalImg.src=src}
modal.onclick=()=>modal.style.display="none";
modeToggle.onclick=()=>document.body.classList.toggle("dark");

/* ---------- AUTO LOAD ---------- */
(async()=>{
await Promise.all([loadRoute(),loadEv()]);
loading.style.display="none";
app.style.display="block";
modeToggle.style.display="block";
})();
</script>
</body>
</html>
