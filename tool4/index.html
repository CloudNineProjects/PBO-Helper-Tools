<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Database</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #666769;
      color: white;
    }
    body.dark {
      background-color: #1A252C;
      color: white;
    }
    .container {
      padding: 20px;
      text-align: center;
    }
    .card {
      background-color: #026503;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      max-width: 800px;
    }
    body.dark .card {
      background-color: #023804;
    }
    select, button {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    select {
      background: white;
      color: black;
    }
    body.dark select {
      background: black;
      color: white;
    }
    button {
      background-color: #444;
      color: white;
      cursor: pointer;
    }
    .results {
      margin-top: 20px;
      text-align: left;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
    }
    th {
      background-color: #444;
      color: white;
    }
    .dark th {
      background-color: #222;
    }
    .comments {
      white-space: pre-wrap;
    }
    .toggle-container {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .toggle-btn {
      cursor: pointer;
      font-size: 20px;
    }
    #loadingScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #1A252C;
      color: white;
    }
    #loadingScreen img {
      max-width: 200px;
      margin-bottom: 20px;
    }
    #app {
      display: none;
    }
  </style>
</head>
<body>
  <div id="loadingScreen">
    <div class="toggle-container">
      <span id="modeText">Dark Mode</span>
      <span class="toggle-btn" id="modeToggle">🌙</span>
    </div>
    <img src="https://i.imgur.com/XZcfQzw.png" alt="Loading">
    <button onclick="loadData()">Load Data</button>
    <p id="loadingStatus"></p>
  </div>

  <div id="app">
    <div class="toggle-container">
      <span id="modeTextApp">Dark Mode</span>
      <span class="toggle-btn" id="modeToggleApp">🌙</span>
    </div>

    <div class="container">
      <h1>Team Database</h1>
      <div class="card">
        <label for="contentSelect">Select Content:</label>
        <select id="contentSelect"></select>
        <button onclick="showResults()">Show</button>
        <button onclick="resetForm()">Reset</button>
      </div>
      <div class="results" id="results"></div>
    </div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTZms-FGa78v8FvI5CqYGTck1d_TU0yzWGc-UVXhoEpcp3W0zF5aPdr5ZGFYc-nfWUkgVUhtEDZCfR/pub?output=csv";
    let allData = [];

    function escapeHtml(text) {
      return text.replace(/[&<>'"]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function parseCSV(str) {
      const rows = str.split(/\r?\n/).map(r => r.split(","));
      const headers = rows.shift();
      return rows.filter(r => r.length >= 4).map(r => {
        const obj = {};
        headers.forEach((h,i)=>obj[h.trim()] = r[i]||"");
        return obj;
      });
    }

    async function loadData() {
      document.getElementById("loadingStatus").innerText = "Loading...";
      try {
        const res = await fetch(sheetUrl);
        const text = await res.text();
        allData = parseCSV(text);

        populateContentSelect();
        document.getElementById("loadingScreen").style.display = "none";
        document.getElementById("app").style.display = "block";
      } catch(e) {
        document.getElementById("loadingStatus").innerText = "Error loading data";
      }
    }

    function populateContentSelect() {
      const contentSelect = document.getElementById("contentSelect");
      contentSelect.innerHTML = "";
      const contents = [...new Set(allData.map(r => r["Content"]))].filter(x=>x);
      contents.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        contentSelect.appendChild(opt);
      });
    }

    function showResults() {
      const selectedContent = document.getElementById("contentSelect").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      const matches = allData.filter(r => r["Content"] === selectedContent);

      if(matches.length === 0) {
        resultsDiv.innerText = "No data found.";
        return;
      }

      let html = "<table><tr><th>Content</th><th>Accessibility</th><th>Team Link</th><th>Comments</th></tr>";
      matches.forEach(r => {
        const keyA = "Content", keyB = "Accessibility", keyC = "Team Link", keyD = "Comments";
        let rawUrl = (r[keyC] || '').trim();

        // FIX: falls Sheets HYPERLINK-Formel exportiert
        const match = rawUrl.match(/"(https?:\/\/[^"]+)"/i);
        if (match) {
          rawUrl = match[1];
        }

        const safeText = escapeHtml(rawUrl);
        const linkVal = rawUrl ? `<a href="${rawUrl}" target="_blank" rel="noopener noreferrer">${safeText}</a>` : '';

        html += "<tr>";
        html += `<td>${escapeHtml(r[keyA]||'')}</td>`;
        html += `<td>${escapeHtml(r[keyB]||'')}</td>`;
        html += `<td>${linkVal}</td>`;
        html += `<td><pre class="comments">${escapeHtml(r[keyD]||'')}</pre></td>`;
        html += "</tr>";
      });
      html += "</table>";

      resultsDiv.innerHTML = html;
    }

    function resetForm() {
      document.getElementById("contentSelect").selectedIndex = 0;
      document.getElementById("results").innerHTML = "";
    }

    // Mode toggle
    function setMode(dark) {
      if(dark) {
        document.body.classList.add("dark");
        document.getElementById("modeText").innerText = "Dark Mode";
        document.getElementById("modeTextApp").innerText = "Dark Mode";
        document.getElementById("modeToggle").innerText = "🌙";
        document.getElementById("modeToggleApp").innerText = "🌙";
      } else {
        document.body.classList.remove("dark");
        document.getElementById("modeText").innerText = "Light Mode";
        document.getElementById("modeTextApp").innerText = "Light Mode";
        document.getElementById("modeToggle").innerText = "☀️";
        document.getElementById("modeToggleApp").innerText = "☀️";
      }
    }

    let darkMode = true;
    document.getElementById("modeToggle").addEventListener("click", ()=>{darkMode=!darkMode;setMode(darkMode)});
    document.getElementById("modeToggleApp").addEventListener("click", ()=>{darkMode=!darkMode;setMode(darkMode)});
    setMode(darkMode);
  </script>
</body>
</html>
